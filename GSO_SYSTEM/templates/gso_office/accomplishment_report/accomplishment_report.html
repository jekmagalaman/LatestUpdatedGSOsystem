{% extends "gso_office/gso_base_dashboard.html" %}

{% block title %}Work Accomplishment Report{% endblock %}

{% block main_content %}
<style>
  /* === Global Enhancements === */
  .page-title {
    font-weight: 700;
    color: #f8f9fb;
  }

  .header {
    background: #002e72;
    border-radius: 10px;
    padding: 1rem 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  select.form-select {
    border-radius: 8px;
    border: 1px solid #dee2e6;
  }

  .card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden;
  }

  table thead {
    background: #002e72;
    color: #fff;
    font-size: 0.9rem;
  }

  table tbody tr:hover {
    background-color: #f6f9ff;
    transition: 0.2s ease;
  }

  .badge {
    font-size: 0.8rem;
    border-radius: 6px;
  }

  .btn-outline-primary {
    border-radius: 6px;
    transition: all 0.2s ease;
  }

  .btn-outline-primary:hover {
    background-color: #002e72;
    color: #fff;
    transform: translateY(-2px);
  }

  /* ===== Modal Styling ===== */
  .modal-content {
    border: none;
    border-radius: 12px;
    box-shadow: 0 5px 25px rgba(0,0,0,0.15);
  }

  .modal-header {
    background: #002e72;
    color: white;
    border-bottom: none;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
  }

  .modal-header .btn-close {
    filter: invert(1);
    opacity: 0.8;
  }

  .modal-header .btn-close:hover {
    opacity: 1;
  }

  .modal-body {
    background: #ffffff;
    padding: 1.5rem;
  }

  .modal-footer {
    background: #f8f9fb;
    border-top: 1px solid #e5e7eb;
    border-bottom-left-radius: 12px;
    border-bottom-right-radius: 12px;
  }

  .details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px 24px;
  }

  .detail-item label {
    font-size: 0.8rem;
    color: #6b7280;
    text-transform: uppercase;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .detail-item span,
  .detail-item p {
    font-size: 0.95rem;
    color: #111827;
    line-height: 1.5;
  }

  .description-box {
    grid-column: span 2;
  }

  .description-box p {
    background: #f9fafb;
    padding: 10px 12px;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    white-space: pre-line;
  }

  .approve-btn {
    background: #22c55e;
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 500;
    transition: 0.2s ease;
  }

  .approve-btn:hover {
    background: #16a34a;
    transform: translateY(-1px);
  }

  @media (max-width: 768px) {
    .details-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<!-- ======= PAGE HEADER ======= -->
<div class="header d-flex flex-wrap align-items-center justify-content-between mb-4">
  <h1 class="page-title mb-2 mb-md-0">Work Accomplishment Report</h1>

  <form method="get" class="d-flex gap-2 align-items-center filter-form">
    <input 
      type="text" 
      name="user_status" 
      class="form-control form-control-sm" 
      placeholder="Search reports..." 
      value="{{ request.GET.user_status }}">
    <select name="unit" class="form-select form-select-sm" onchange="this.form.submit()">
      <option value="">All Units</option>
      <option value="repair and maintenance" {% if request.GET.unit == 'repair and maintenance' %}selected{% endif %}>Repair and Maintenance</option>
      <option value="utility" {% if request.GET.unit == 'utility' %}selected{% endif %}>Utility</option>
      <option value="electrical" {% if request.GET.unit == 'electrical' %}selected{% endif %}>Electrical</option>
      <option value="motorpool" {% if request.GET.unit == 'motorpool' %}selected{% endif %}>Motorpool</option>
    </select>
  </form>

  <button type="button" class="btn btn-primary d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#ipmtModal">
    <i class="bi bi-file-earmark-bar-graph me-2"></i> Generate IPMT
  </button>
</div>

<!-- ======= IPMT MODAL ======= -->
<div class="modal fade" id="ipmtModal" tabindex="-1" aria-labelledby="ipmtModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="get" action="{% url 'gso_reports:preview_ipmt' %}">
        <div class="modal-header">
          <h5 class="modal-title fw-semibold">Generate IPMT Report</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="unit" class="form-label">Select Unit</label>
            <select name="unit" id="unit" class="form-select" onchange="filterPersonnel()">
              <option value="">All Units</option>
              <option value="repair and maintenance">Repair and Maintenance</option>
              <option value="utility">Utility</option>
              <option value="electrical">Electrical</option>
              <option value="motorpool">Motorpool</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Select Personnel (optional)</label>
            <div id="personnel-container" class="d-flex flex-column border rounded p-3" style="max-height:200px; overflow-y:auto;"></div>
            <small class="text-muted">You may select multiple personnel.</small>
          </div>

          <div class="mb-3">
            <label for="month" class="form-label">Select Month</label>
            <input type="month" name="month" id="month" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success px-4">
            <i class="bi bi-eye me-1"></i> Generate Preview
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ======= REPORTS TABLE ======= -->
<div class="table-container mt-3">
  <div class="table-responsive">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Date</th>
          <th>Unit</th>
          <th>Description</th>
          <th>Requesting Office</th>
          <th>Personnel</th>
          <th>Status</th>
          <th>Rating</th>
          <th>Source</th>
        </tr>
      </thead>
      <tbody>
        {% if reports %}
          {% for report in reports %}
          <tr>
            <td>{{ report.date|date:"Y-m-d" }}</td>
            <td><span class="fw-semibold">{{ report.unit|title }}</span></td>
            <td>
              <span class="war-desc" id="war-description-{{ report.id }}" data-id="{{ report.id }}" data-type="{{ report.type }}">
                {% if report.type == "WorkAccomplishmentReport" %}
                  <span class="spinner-border spinner-border-sm text-primary" role="status"></span>
                  Generating AI description...
                {% else %}
                  {{ report.display_description|default:"(No description)" }}
                {% endif %}
              </span>
            </td>
            <td>{{ report.requesting_office }}</td>
            <td>{% for p in report.personnel %}<span class="badge bg-light text-dark border me-1">{{ p }}</span>{% endfor %}</td>
            <td><span class="badge bg-info text-dark">{{ report.status|default:"Completed" }}</span></td>
            <td>{{ report.rating|default:"Not Rated" }}</td>
            <td>
              {% if report.request %}
                <span class="badge bg-success">Live</span>
              {% else %}
                <span class="badge bg-secondary">Migrated</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="8" class="text-center text-muted py-4">No reports available.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- ======= PERSONNEL JSON ======= -->
{{ personnel_list|json_script:"personnel-data" }}

<script>
const personnelList = JSON.parse(document.getElementById('personnel-data').textContent);
const personnelData = {};

personnelList.forEach(p => {
  const unit = p.unit || 'unassigned';
  if (!personnelData[unit]) personnelData[unit] = [];
  personnelData[unit].push({
    name: p.full_name || p.username,
    safeId: (p.full_name || p.username).replace(/\s+/g, '-')
  });
});

const personnelContainer = document.getElementById('personnel-container');

function filterPersonnel() {
  const selectedUnit = document.getElementById('unit').value || '';
  personnelContainer.innerHTML = "";

  const list = selectedUnit && personnelData[selectedUnit] ? personnelData[selectedUnit] : Object.values(personnelData).flat();

  if (!list.length) {
    personnelContainer.innerHTML = "<p class='text-muted'>No personnel available</p>";
    return;
  }

  list.forEach(p => {
    const div = document.createElement("div");
    div.classList.add("form-check");
    div.innerHTML = `
      <input class="form-check-input" type="checkbox" name="personnel[]" value="${p.name}" id="person_${p.safeId}">
      <label class="form-check-label" for="person_${p.safeId}">${p.name}</label>
    `;
    personnelContainer.appendChild(div);
  });
}

async function fetchWarDescription(warId, retries = 15) {
  if (retries <= 0) return;
  try {
    const res = await fetch(`/gso_reports/war-description/${warId}/`);
    const data = await res.json();
    if (data.description?.trim()) {
      document.getElementById(`war-description-${warId}`).innerHTML = data.description;
    } else {
      setTimeout(() => fetchWarDescription(warId, retries - 1), 2000);
    }
  } catch {
    setTimeout(() => fetchWarDescription(warId, retries - 1), 2000);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  filterPersonnel();
  {% for report in reports %}
    {% if report.type == "WorkAccomplishmentReport" %}
      fetchWarDescription({{ report.id }});
    {% endif %}
  {% endfor %}
});
</script>
{% endblock %}
